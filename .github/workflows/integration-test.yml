name: integration-test

on:
  pull_request:
    branches: [main]

jobs:

  build:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
  
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
  
      - name: Build with Maven
        run: mvn compile
  
  test:
      needs: build
      runs-on: ubuntu-latest
  
      services:
        mysql:
          image: mysql:latest
          env:
            MYSQL_ROOT_PASSWORD: MyPass
            MYSQL_DATABASE: cloudproject
            MYSQL_USER: abhi
            MYSQL_PASSWORD: MyPass
          ports:
            - 3306:3306
          options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
  
      steps:
        - name: Checkout
          uses: actions/checkout@v3
  
        - name: Setup JDK 17
          uses: actions/setup-java@v3
          with:
            java-version: '17'
            distribution: 'temurin'
  
        - name: Run Spring Boot application with MySQL
          run: mvn spring-boot:run -Dspring.datasource.url=jdbc:mysql://localhost:3306/cloudproject -Dspring.datasource.username=root -Dspring.datasource.password=MyPass -Dspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver -Dspring.jpa.hibernate.ddl-auto=update -Dspring.datasource.hikari.connection-timeout=20000
  
        - name: Wait for application to start
          run: sleep 40 
  
        - name: Run integration tests
          run: mvn test
  